# Puppet Configuration Management Lab Guide

## Introduction

This lab guide will walk you through setting up a Puppet environment and performing various configuration management tasks. You'll learn how to use Puppet to manage both Linux and Windows servers, automating the deployment of software and configurations.

## Lab Environment
Your lab environment consists of:

- One Linux server (Puppet Master)
- One Linux workstation (Puppet Agent)
- Two Windows servers (Puppet Agents)

## Components Overview

- Puppet Server: The central hub that manages the configuration data and serves it to Puppet agents.
- Puppet Agent: Software installed on each node (server) that Puppet manages.
- PuppetDB: A database that stores data generated by Puppet.
- Hiera: Puppet's built-in key-value configuration data lookup system.
- Facter: A system profiling library that discovers and reports per-node facts.
- Modules: Collections of manifests and data that encapsulate a discrete unit of configuration.
- Manifests: Written in Puppet's domain-specific language, they define the desired state of the system.

## Setup

### Puppet Master: Initial Server Setup

In this section, you'll set up the Chef Server on your Linux master server.  This server is the **linux1** .  SSH into the linux master Ubuntu 22.04 by looking at the results from ```terraform output```.  You might need to wait until all of the packages have installed (bootstrap complete) before starting this process.  You can ```tail -f /var/log/user-data.log``` and watch the logfile in realtime.  When bootstrap is complete, you should see **End of bootstrap script**.

1. SSH into **linux1** master system.  The Puppet software has already been installed on the linux1 master through the terraform bootstrap script and processes with user-data and ec2-agent.  Go ahead and start/enable the service and verify that it is now running:
   ```bash
   sudo systemctl start puppetserver
   sudo systemctl enable puppetserver
   ```

   Verify that the Puppet Server is running:
   ```bash
   sudo systemctl status puppetserver
   ```

2. On **linux1** system:  Set up a hostname on the linux system for puppet server.
   ```bash
   sudo hostnamectl set-hostname puppet.example.local
   ```

   Set up the ```/etc/hosts``` file to include the fqdn and private IP address.  You can get the private IP address for lin1 via ifconfig or terraform outputs:
   ```bash
   sudo vi /etc/hosts
   ```

   For my example, I am adding the line with private IP address of ```10.100.20.204```:
   ```bash
   10.100.20.204 puppet.example.local puppet
   ```

   Reboot your lin1 Puppet master server by typing **sudo reboot**.
   ```bash
   sudo reboot
   ```

4. Generate a self-signed certificate for the Puppet Master with the FQDN ```puppet.example.local``` and restart the Puppet Master service telling it to use the new certificate.  Let's walk through the process.

   We will now generate a default SSL certificate.  First, we'll delete the default certificate path:
   ```bash
   sudo rm -rf /etc/puppetlabs/puppet/ssl
   sudo rm -rf /etc/puppetlabs/puppetserver/ca
   ```

   Configure Puppet server to use these certificates.  Edit the puppet.conf file:
   ```bash
   sudo vi /etc/puppetlabs/puppet/puppet.conf
   ```

   Add this content into the end of the file:
   ```bash
   [main]
   certname = puppet.example.local
   server = puppet.example.local
   ```

   Generate a CA with the following commands.  This will create a default certificate with the certname listed from **puppet.conf**.
   ```bash
   sudo /opt/puppetlabs/bin/puppetserver ca setup
   ```

   You should see a positive response:
   ```
   Generation succeeded. Find your files in /etc/puppetlabs/puppetserver/ca
   ```

   Restart the Puppet server to apply these changes:
   ```bash
   sudo systemctl restart puppetserver
   ```


   Nice job!  You are now all set after configuring your Puppet server to use the self-signed certificate.  If you run into any issues, just do a ```sudo reboot```.
   

### Puppet Linux Agent:  Reconfigure for self-signed TLS certificate

We are going to set up the Puppet agent system for mutual TLS authentication, so it can communicate to Pupper master and receive configuration changes.  On **linux2**, you will need to generate a new self-signed TLS certificate that can be used to simulate proper DNS and certificate based authentication.  We will **cheat** here by using the /etc/hosts for DNS.

1. On **linux2** system:  Set up a hostname on the linux system for the puppet agent to have a FQDN for certificates.
   ```bash
   sudo hostnamectl set-hostname lin2.example.local
   ```

   Set up the /etc/hosts file to include the fqdn and private IP address for both **puppet** (lin1) and pupper agent (lin2).  You can get the private IP address for lin12 via ifconfig or terraform outputs:
   ```bash
   sudo vi /etc/hosts
   ```

   For my example, I am adding the line with private IP address of ```10.100.20.204```:
   ```bash
   10.100.20.204 puppet.example.local puppet
   10.100.20.170 lin2.example.local lin2
   ```

   Now you should be able to successfully ping **puppet.example.local**!

   Reboot your lin2 Puppet agent system by typing **sudo reboot**.  This will ensure all changes take effect.

   ```bash
   sudo reboot
   ```

3. SSH back into your lin2 chef agent system.  We will now update the Puppet configuration file to point to our puppet server.  Edit the following file:
   ```bash
   sudo vi /etc/puppetlabs/puppet/puppet.conf
   ```

   Add the **[main]** section to the end of the file:
   ```bash
   [main]
   certname = lin2.example.local
   server = puppet.example.local
   ```
   This tells the puppet agent the local certificate that will be used as well as the puppet server to communicate with.

4. Now we are ready to generate a new certificate request with the correct hostname and send this to the puppet server.  Let's first remove any existing Puppet SSL certificates.  On **lin2**, run the following commands:
   ```bash
   sudo rm -rf /etc/puppetlabs/puppet/ssl
   ```

   Run the Puppet agent to generate a new certificate request:
   ```bash
   sudo /opt/puppetlabs/bin/puppet agent -t
   ```

   It is normal to see the following response, since the server is not automatically signing certificate requests:
   ```bash
   Info: Certificate for lin2.example.local has not been signed yet
   Couldn't fetch certificate from CA server; you might still need to sign this agent's certificate (lin2.example.local).
   Exiting now because the waitforcert setting is set to 0.
   ```

   On **puppet** server:  Now we need to approve the pending certificate request on the puppet master.  Back on the **puppet** chef master linux system, list the pending certificate requests:
   ```bash
   sudo /opt/puppetlabs/bin/puppetserver ca list
   ```

   You should see the pending certificate from lin2:
   ```bash
   Requested Certificates:
    lin2.example.local
   ```

   Sign all pending requests:
   ```bash
   sudo /opt/puppetlabs/bin/puppetserver ca sign --all
   ```

   You should see this response:
   ```bash
   Successfully signed certificate request for lin2.example.local
   ```

   Back on **lin2** chef agent, run the puppet agent command again to fetch a certificate from the server:
   ```bash
   sudo /opt/puppetlabs/bin/puppet agent -t
   ```

   You should see a line with the response of:
   ```bash
   Info: Downloaded certificate for lin2.example.local from https://puppet.example.local:8140/puppet-ca/v1
   ```

   Nice job!  You are now ready for Configuration Management as Code:  That is, creating a manifest / module to pull configuration changes to the puppet agent!

### Puppet Master:  Create a Linux Manifest Module

In this section, you'll set up a Manifest Module for configuration changes you can push to the puppet agents.  SSH into the linux master Ubuntu 22.04 by looking at the results from ```terraform output```.  For this manifest, we will create an auditd linux configuration.

1. On the Puppet master, create a new module directory structure:
   ```bash
   sudo mkdir -p /etc/puppetlabs/code/environments/production/modules/auditd/{manifests,files}
   ```

2. Create the main manifest file for the auditd module:
   ```bash
   sudo vi /etc/puppetlabs/code/environments/production/modules/auditd/manifests/init.pp
   ```

   Add the following into the init.pp file by copying and pasting:
   ```bash
   class auditd {
     package { 'auditd':
       ensure => installed,
     }

     service { 'auditd':
       ensure  => running,
       enable  => true,
       require => Package['auditd'],
     }

     file { '/etc/audit/auditd.conf':
       ensure  => file,
       owner   => 'root',
       group   => 'root',
       mode    => '0640',
       source  => 'puppet:///modules/auditd/auditd.conf',
       require => Package['auditd'],
       notify  => Service['auditd'],
     }

     file { '/etc/audit/audit.rules':
       ensure  => file,
       owner   => 'root',
       group   => 'root',
       mode    => '0640',
       source  => 'puppet:///modules/auditd/audit.rules',
       require => Package['auditd'],
       notify  => Service['auditd'],
     }
   }
   ```

3. Create a sample ```auditd.conf``` file:
   ```bash
   sudo vi /etc/puppetlabs/code/environments/production/modules/auditd/files/auditd.conf
   ```

   Copy and paste the following into the file:
   ```
   log_file = /var/log/audit/audit.log
   log_format = RAW
   log_group = root
   priority_boost = 4
   flush = INCREMENTAL_ASYNC
   freq = 20
   num_logs = 5
   disp_qos = lossy
   dispatcher = /sbin/audispd
   name_format = NONE
   ##name = mydomain
   max_log_file = 6 
   max_log_file_action = ROTATE
   space_left = 75
   space_left_action = SYSLOG
   action_mail_acct = root
   admin_space_left = 50
   admin_space_left_action = SUSPEND
   disk_full_action = SUSPEND
   disk_error_action = SUSPEND
   ```
   
4. Create a sample ```audit.rules``` file:

   ```bash
   sudo vi /etc/puppetlabs/code/environments/production/modules/auditd/files/audit.rules
   ```

   Copy and paste the following into the file:
   ```bash
   # First rule - delete all
   -D

   # Increase the buffers to survive stress events.
   # Make this bigger for busy systems
   -b 8192

   # Audit the audit logs
   -w /var/log/audit/ -k auditlog

   # Auditd configuration
   -w /etc/audit/ -p wa -k auditconfig
   -w /etc/libaudit.conf -p wa -k auditconfig
   -w /etc/audisp/ -p wa -k audispconfig

   # Monitor for use of audit management tools
   -w /sbin/auditctl -p x -k audittools
   -w /sbin/auditd -p x -k audittools

   # Monitor AppArmor configuration changes
   -w /etc/apparmor/ -p wa -k apparmor
   -w /etc/apparmor.d/ -p wa -k apparmor

   # Monitor usage of passwd command
   -w /usr/bin/passwd -p x -k passwd_modification

   # Monitor user/group tools
   -w /usr/sbin/groupadd -p x -k group_modification
   -w /usr/sbin/groupmod -p x -k group_modification
   -w /usr/sbin/addgroup -p x -k group_modification
   -w /usr/sbin/useradd -p x -k user_modification
   -w /usr/sbin/usermod -p x -k user_modification
   -w /usr/sbin/adduser -p x -k user_modification

   # Monitor changes to /etc/passwd and /etc/shadow
   -w /etc/passwd -p wa -k passwd_changes
   -w /etc/shadow -p wa -k shadow_changes
   ```

5. Now that you've created the module, next things get more interesting.  You're going to edit a ```site.pp``` file to include the auditd module for your specific linux puppet client:
   ```bash
   sudo vi /etc/puppetlabs/code/environments/production/manifests/site.pp
   ```

   Modify the node definition for your linux client named **lin2**:
   ```bash
   node 'lin2.example.local' {
     include auditd
   }
   ```

### Puppet Linux Agent:  Apply the Manifest Changes

1. On the Linux client, run the Puppet agent to apply the new configuration:
   ```bash
   sudo /opt/puppetlabs/bin/puppet agent -t
   ```

   You should see a lot of output showing the system requesting its catalog and applying configuration.  The following lines should be visible:
   ```bash
   Info: /Stage[main]/Auditd/File[/etc/audit/audit.rules]: Scheduling refresh of Service[auditd]
   Notice: /Stage[main]/Auditd/Service[auditd]: Triggered 'refresh' from 2 events
   Notice: Applied catalog in 10.27 seconds
   ```

   Congrats and well done!  You have successfully created and applied a manifest to a linux agent via Puppet.


### Puppet Windows Agent Setup

In this section, you'll set up the two Windows systems with the puppet agent so they can be configured with manifests.  Let' dig into this and get the Windows systems setup with TLS authentication to the Puppet master server.

1. RDP into the windows1 system.  Get the credentials and ```Public IP``` address from the output from ```terraform output```.  It will be included in this section.  Ensure that you use the local Admin and password:
   ```bash
   -------------------------
   Virtual Machine win1
   -------------------------
   Instance ID: i-0e5a34a20ebac69e1
   Computer Name:  win1
   Private IP: 10.100.20.104
   Public IP:  <your_public_ip>
   local Admin:  RTCAdmin
   local password: Proud-lion-2024!
   Ansible User:  ansible
   Ansible Pass:  Brave-monkey-2024!
   ```

2. Open up Notepad and **Run as Administrator**.  Open and edit the following Puppet configuration file:
   ```bash
   C:\ProgramData\PuppetLabs\puppet\etc\puppet.conf
   ```

   Edit the main section already included to allow the correct server for the puppet master server:
   ```
   [main]
   server = puppet.example.local
   ```
   Save when you are done but keep Notepad open (you'll be using it again in the next step).  This will ensure that the puppet agent will attempt TLS authentication with your server.

3. Next, we need to add an entry to the hosts file on windows  so the system can reach the puppet master server.  Get the  IP address of the puppet linux master ready, and edit the following file with notepad and **Run as Administrator**:
   ```bash
   C:\Windows\System32\drivers\etc\hosts
   ```

   Add the following line, adapting to the correct puppet linux master server.  For my example, it is 10.100.20.37.  Yours will be different.
   ```bash
   10.100.20.37 puppet.example.local
   ```
   Save the file when you are done.  From a cmd prompt in Windows, you should be able to resolve and ping **puppet.example.local**

4. Open up a new ```Windows Powershell``` session and *Run as Administrator**.  Start the puppet service:
   ```bash
   Start-Service -Name puppet
   ```

   Run the Puppet agent to generate a certificate request:
   ```
   & 'C:\Program Files\Puppet Labs\Puppet\bin\puppet.bat' agent -t
   ```

   You should see a response in green indicating that a request for a certificate was made.
   ```
   Info: Creating a new SSL certificate request for win1.us-east-2.compute.internal
   ```

5. Return to the Linux puppet master.  You will need to sign the certificate request from windows1.  Type the following to show the pending certificate requests (**Requested Certificates**):
   ```bash
   sudo /opt/puppetlabs/bin/puppetserver ca list --all
   ```
   You should see a pending request from **win1.us-east-2.compute.internal**

   Sign the certificate by typing:
   ```
   sudo /opt/puppetlabs/bin/puppetserver ca sign --all
   ```

   You should see a response similar to:
   ```bash
   Successfully signed certificate request for win1.us-east-2.compute.internal
   ```

6. Returning to the Windows system, run the Puppet agent once again in the same  Powershell session:
   ```
   & 'C:\Program Files\Puppet Labs\Puppet\bin\puppet.bat' agent -t
   ```

   You might see some certificate errors in red.  This is expected for this lab setup:
   ```
   Error: request https://puppet.example.local:8140//puppet-ca/v1/certificate_revocation_list/ca failed: SSL_connect returned=1 errno=0    state=error: certificate verify failed
   Error: Could not request certificate: SSL_connect returned=1 errno=0 state=error: certificate verify failed: [unable to get issuer certificate for /CN=Puppet CA: puppet.example.local]
   ```

   To resolve for this lab, we need to manually copy over the public certificate on the puppet master and paste it into the local trusted certificate file on the windows system.

   On the puppet master linux, copy the contents of this file by typing:
   ```
   sudo cat /etc/puppetlabs/puppet/ssl/certs/ca.pem
   ```

   On the Windows system, using Notepad as Administrator, manually edit the following file:
   ```bash
   C:\ProgramData\PuppetLabs\puppet\etc\ssl\certs\ca.pem
   ```

   Paste the entire contents of the **ca.pem** on the master server into this file and save.

   Run the Puppet agent once again in the same  Powershell session and now you should see that you make it past this area with some green in which the catalog of changes are checked on the server for your system.  It is normal at this point that nothing is returned, since we haven't yet set up a manifest for this windows host:
   ```
   & 'C:\Program Files\Puppet Labs\Puppet\bin\puppet.bat' agent -t
   ```

   You will see this:
   ```bash
   Info: Retrieving pluginfacts
   Info: Retrieving plugin
   Info: Retrieving locales
   Error: Could not retrieve catalog from remote server: Error 500 on SERVER: Server Error: Could not find node statement with name 'default' or 'win1.us-east-2.compute.internal' on node win1.us-east-2.compute.internal
   ```

   Excellent work!  We are now ready to create a manifest on puppet master for some changes we will push.

7.  Repeat the same steps for Windows2 system.  Get the public IP address from ```terraform output``` as you did before.

### Puppet Master:  Create a Windows Manifest

In this section, you'll create a Windows manifest that can add windows audit logging best practices.  Let's dive in.

1. On the Puppet master, create a new module directory structure for Windows logging and auditing:
   ```bash
   sudo mkdir -p /etc/puppetlabs/code/environments/production/modules/windows_audit_policy/{manifests,files}
   ```

2. Create the main manifest file for the windows_audit_policy module:
   ```bash
   cd /etc/puppetlabs/code/environments/production/modules/windows_audit_policy
   sudo vi manifests/init.pp
   ```

   Add the following into the init.pp file by copying and pasting:
   ```bash
   class windows_audit_policy {
     exec { 'Configure Audit Policy and Process Creation Auditing':
       command  => template('windows_audit_policy/configure_audit.ps1'),
       provider => 'powershell',
     }
   }
   ```

3. Create a template for the powershell script that will be applied.  The powershell script is **configure_audit.ps1** and will be placed into the templates directory.
   ```bash
   sudo mkdir templates
   ```

4. Now let's edit the powershell script.
   ```bash
   sudo vi templates/configure_audit.ps1.erb
   ```

   Copy and paste the following into the file:
   ```bash
   # Enable advanced audit policy
   auditpol /set /subcategory:"Security System Extension" /success:enable /failure:enable
   auditpol /set /subcategory:"System Integrity" /success:enable /failure:enable
   auditpol /set /subcategory:"Logon" /success:enable /failure:enable
   auditpol /set /subcategory:"Logoff" /success:enable /failure:enable
   auditpol /set /subcategory:"Account Lockout" /success:enable /failure:enable
   auditpol /set /subcategory:"Special Logon" /success:enable /failure:enable
   auditpol /set /subcategory:"Process Creation" /success:enable /failure:enable

   # Enable command line process auditing
   $regPath = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit"
   if (-not (Test-Path $regPath)) {
     New-Item -Path $regPath -Force | Out-Null
   }
   Set-ItemProperty -Path $regPath -Name "ProcessCreationIncludeCmdLine_Enabled" -Value 1 -Type DWord

   # Enable PowerShell script block logging
   $regPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging"
   if (-not (Test-Path $regPath)) {
     New-Item -Path $regPath -Force | Out-Null
   }
   Set-ItemProperty -Path $regPath -Name "EnableScriptBlockLogging" -Value 1 -Type DWord

   # Configure Windows Event Log sizes
   Limit-EventLog -LogName Application -MaximumSize 1GB
   Limit-EventLog -LogName Security -MaximumSize 1GB
   Limit-EventLog -LogName System -MaximumSize 1GB

   Write-Host "Audit policies and logging have been configured."
   ```

5. Edit the ```site.pp``` to include the new module for your Windows nodes:
   ```bash
   sudo vi /etc/puppetlabs/code/environments/production/manifests/site.pp
   ```

   Add the following to the file.  This will add a regular expression so that every windows host system has the following policy applied:
   ```bash
   node /^win\d+\.example\.local$/ {
     include windows_audit_policy
   }
   ```

### Puppet Windows Agent:  Apply the Manifest Changes

1. On the Windows1 or Windows2 client, ensure that you have a Windows Powershell session that is **Run as Administrator**.  Run the puppet agent to apply the new configuration:
   ```
   & 'C:\Program Files\Puppet Labs\Puppet\bin\puppet.bat' agent -t
   ```

Congrats and well done!  You have successfully created and applied a manifest to a linux agent via Puppet.

   

   
   
   




   
